# Import Users from CSV

**Note: this script should be run using a global API key (and not a personal/user API key). If a personal API token is used, this user will be added to every created team**

## Input Format

To use this script, you must first have a CSV file ready formatted as follows:

```
name,email,role,title,country_code,phone_number,teams
```

In this format:

- `country_code` is the phone country code, and `phone_number` is the number
  without country code
- `teams` is a semicolon-delimited list of teams to which the given user should
  be added
- `email` is the user's login address, and it must uniquely match the user.
- `role` must be a valid user role value; see [Roles in the REST API and
  SAML](https://support.pagerduty.com/v1/docs/advanced-permissions#section-roles-in-the-rest-api-and-saml)
  in the PagerDuty Knowledge Base.
- there must be no spaces between the commas and the items they separate   

## Input Format

To execute the script, run:

```
ruby import_users.rb -a API_KEY_HERE -f PATH_TO_FILE_HERE -e REQUESTER_EMAIL
```

## Errors

Errors are printed to the terminal as they happen, and are also recorded in a log file named after the requester_email. The log file will tell you the HTTP status, the response body, and the attempted payload or query.

## Notes and Caveats
Use --help to view all commandline options. There is an option (-t) that will create teams for you if they do not already exist.
Whitespace is bad. The only place where whitespace is permitted is between the first and last names and inside team names. There cannot be whitespace anywhere else in the CSV.
If you'd like to skip fields, you need to supplement the empty fields with commas. For example, if I want to skip title, country code, and phone number, my line would look like this:
```
Alex Thompson,alex.t@example.com.invalid,,,,Best Team Ever
```

Team names cannot contain the following characters: '\\', '/', '&', '<', '>' or non-printable characters.

### Each user will be sent an invitation email the moment that they are created

This is a latent feature of the REST API that cannot be disabled. However, it
is possible to stop invites from being sent by appending `.invalid` to the
email addresses when importing. Later on, the email addresses can be updated in
bulk using a different automation.

### The script can also be used to modify users in bulk

If the users corresponding to the email addresses already exist in the account,
then they will be added to the teams specified in the last column of the input
CSV, and moreover, contact methods will be added to them. However, if they
already have contact methods matching the phone numbers, an error will be
raised and the script will proceed to the next user without continuing work on
that user (i.e. adding them to teams).

If only adding users to a team, one can leave the phone number and phone
country code columns blank.

### The parser cannot gracefully handle unicode characters or Windows-style linebreaks

If the CSV was generated by Microsoft Word, you should check the file first to
see if it has only Windows-stylle line endings. If it does, the parser will
treat the whole file as if it were one line. If in doubt, use the
[dos2unix](http://dos2unix.sourceforge.net/) tool to convert the file.

Moreover, some difficulty has been observed using this script with input files
that contain unicode characters.
